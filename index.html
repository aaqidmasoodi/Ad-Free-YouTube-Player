<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#ff0000">
  <meta name="description" content="Ad Free Player - Create YouTube playlists without ads">
  
  <!-- PWA Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Ad Free Player">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <title>ðŸŽµ Ad Free Player</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
  
  <style>
    :root {
      --primary-color: #ff0000;
      --primary-hover: #cc0000;
      --dark-bg: #121212;
      --card-bg: #1e1e1e;
      --text-primary: #ffffff;
      --text-secondary: #b3b3b3;
    }
    
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      padding: 0;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    /* Fixed app layout for mobile */
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    
    .app-header {
      flex-shrink: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
      z-index: 100;
    }
    
    .app-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 10px;
    }
    
    .app-footer {
      flex-shrink: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 8px 0;
      z-index: 100;
    }
    
    /* Touch-friendly input area */
    .input-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .input-group {
      margin-bottom: 0;
    }
    
    .form-control {
      background: rgba(30, 30, 30, 0.7);
      border: 1px solid #444;
      color: var(--text-primary);
      padding: 12px 15px;
      font-size: 16px; /* Prevents zoom on iOS */
      height: auto;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.2s ease;
      min-height: 48px; /* Touch target size */
    }
    
    .btn-primary:hover:not(:disabled) {
      background-color: var(--primary-hover);
      transform: scale(1.02);
    }
    
    .btn-danger {
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      min-height: 36px;
    }
    
    /* Video player section */
    .player-section {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
    }
    
    #player-container {
      border-radius: 12px;
      overflow: hidden;
      background: #000;
      height: 220px;
    }
    
    /* Video info */
    .video-info {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    /* Playlist section - 50% height */
    .playlist-section {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .playlist-header {
      padding: 12px 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }
    
    .playlist-content {
      flex: 1;
      overflow-y: auto;
      padding: 5px;
    }
    
    /* Playlist items */
    .playlist-item {
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
      border-radius: 8px;
      padding: 12px 10px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.03);
    }
    
    .playlist-item.playing {
      background: rgba(255, 0, 0, 0.15);
      border-left: 3px solid var(--primary-color);
    }
    
    .playlist-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .playlist-item.error {
      background: rgba(255, 0, 0, 0.1);
      border-left: 3px solid #dc3545;
    }
    
    /* Touch-friendly playlist item layout */
    .playlist-item-content {
      display: flex;
      align-items: center;
      width: 100%;
    }
    
    .playlist-item-icon {
      margin-right: 10px;
      font-size: 20px;
      flex-shrink: 0;
    }
    
    .playlist-item-info {
      flex: 1;
      min-width: 0;
      padding-right: 10px;
    }
    
    .playlist-item-title {
      font-size: 15px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 3px;
    }
    
    .playlist-item-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .playlist-item-actions {
      flex-shrink: 0;
    }
    
    /* Empty state */
    .empty-playlist {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-secondary);
    }
    
    .empty-playlist i {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.3;
    }
    
    .empty-playlist h5 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    
    .empty-playlist p {
      font-size: 14px;
      margin-bottom: 0;
    }
    
    /* Footer */
    .footer-content {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
      padding: 0 10px;
    }
    
    .footer-link {
      color: #ff6b6b;
      text-decoration: none;
    }
    
    .footer-link:hover {
      color: #ff0000;
      text-decoration: underline;
    }
    
    /* Custom scrollbar */
    .playlist-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .playlist-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }
    
    .playlist-content::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 3px;
    }
    
    /* App title */
    .app-title {
      font-weight: 800;
      background: linear-gradient(45deg, #ff0000, #ff6b6b);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px rgba(255, 0, 0, 0.2);
      font-size: 24px;
      margin: 0;
      padding: 0;
    }
    
    /* Hide desktop elements on mobile */
    .d-lg-none {
      display: block !important;
    }
    
    .d-none.d-lg-block {
      display: none !important;
    }
    
    /* Responsive adjustments */
    @media (min-width: 576px) {
      .app-content {
        padding: 15px;
      }
      
      #player-container {
        height: 250px;
      }
      
      .form-control {
        padding: 14px 16px;
      }
      
      .btn-primary {
        padding: 14px 24px;
      }
    }
    
    /* Loading titles */
    .video-title-loading {
      font-style: italic;
      color: var(--text-secondary);
    }
    
    /* Prevent scrolling on body */
    body::-webkit-scrollbar {
      display: none;
    }
    
    body {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="container-fluid py-3">
        <div class="d-flex justify-content-between align-items-center">
          <h1 class="app-title mb-0">
            <i class="bi bi-play-btn-fill me-2"></i>
            Ad Free Player
          </h1>
          <button class="btn btn-sm btn-outline-light" onclick="clearPlaylist()">
            <i class="bi bi-trash me-1"></i> Clear
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="app-content">
      <!-- Input Section -->
      <div class="input-section">
        <div class="input-group">
          <input type="text" id="videoUrl" class="form-control" placeholder="Paste YouTube URL or Video ID..." autocomplete="off">
          <button class="btn btn-primary" type="button" onclick="addVideo()">
            <i class="bi bi-plus-circle me-1"></i> Add
          </button>
        </div>
      </div>

      <!-- Video Info -->
      <div id="videoInfo" class="video-info d-none">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-truncate">
            <strong>Now Playing:</strong> <br>
            <span id="currentVideoInfo" class="text-truncate d-inline-block" style="max-width: 200px;"></span>
          </div>
          <span class="badge bg-primary">
            <i class="bi bi-collection-play"></i> 
            <span id="playlistPosition"></span>
          </span>
        </div>
      </div>

      <!-- Player Section -->
      <div class="player-section">
        <div id="player-container">
          <div id="player"></div>
        </div>
      </div>

      <!-- Playlist Section -->
      <div class="playlist-section">
        <div class="playlist-header d-flex justify-content-between align-items-center">
          <h3 class="mb-0">
            <i class="bi bi-list-ul me-2"></i> Playlist
          </h3>
          <span class="badge bg-primary">
            <span id="playlistCount">0</span> videos
          </span>
        </div>
        <div class="playlist-content" id="playlist">
          <div class="empty-playlist">
            <i class="bi bi-music-note-list"></i>
            <h5>No videos yet</h5>
            <p>Add YouTube videos using the input above</p>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="app-footer">
      <div class="container-fluid">
        <div class="footer-content">
          Designed by <a href="https://aaqidmasoodi.com" target="_blank" class="footer-link">Aaqid Masoodi</a> 
          | Copyright Â© <span id="currentYear"></span>
        </div>
      </div>
    </footer>
  </div>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Set current year in footer
    document.getElementById('currentYear').textContent = new Date().getFullYear();
    
    // Global variables
    let playlist = JSON.parse(localStorage.getItem('ytPlaylist')) || [];
    let currentIndex = 0;
    let player;
    let playerReady = false;

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js')
          .then(function(registration) {
            console.log('SW registered: ', registration);
          })
          .catch(function(registrationError) {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
    
    // Load playlist on startup
    window.onload = function () {
      updatePlaylistCount();
      renderPlaylist();
      if (playlist.length > 0) {
        initializePlayer(playlist[0].id);
      }
      // Try to fetch titles for existing videos
      fetchPlaylistTitles();
    };

    // Load YouTube API
    function loadYouTubeAPI() {
      if (window.YT) {
        onYouTubeIframeAPIReady();
        return;
      }
      
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    // YouTube IFrame API Ready
    function onYouTubeIframeAPIReady() {
      playerReady = true;
      if (playlist.length > 0) {
        createPlayer(playlist[0].id);
      }
    }

    function initializePlayer(videoId) {
      loadYouTubeAPI();
    }

    function createPlayer(videoId) {
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: videoId,
        playerVars: {
          'autoplay': 1,
          'controls': 1,
          'showinfo': 0,
          'modestbranding': 1,
          'rel': 0,
          'iv_load_policy': 3
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange,
          'onError': onPlayerError
        }
      });
    }

    function onPlayerReady(event) {
      updateVideoInfo(playlist[currentIndex].id);
      renderPlaylist();
    }

    function onPlayerStateChange(event) {
      // Video ended
      if (event.data === YT.PlayerState.ENDED) {
        playNextVideo();
      }
    }

    function onPlayerError(event) {
      console.log('Player Error:', event.data);
      // Mark video as error and try next
      markVideoAsError(currentIndex, event.data);
      setTimeout(playNextVideo, 1000);
    }

    function playNextVideo() {
      let nextIndex = currentIndex + 1;
      
      // Skip over error videos
      while (nextIndex < playlist.length && playlist[nextIndex].hasError) {
        nextIndex++;
      }
      
      if (nextIndex < playlist.length) {
        playVideoAtIndex(nextIndex);
      } else {
        // No more videos
        document.getElementById('videoInfo').innerHTML = '<strong class="text-warning">Playlist finished</strong>';
        document.getElementById('videoInfo').className = 'video-info d-none';
      }
    }

    function playVideoAtIndex(index) {
      if (index >= 0 && index < playlist.length && !playlist[index].hasError) {
        currentIndex = index;
        
        if (player && playerReady) {
          player.loadVideoById(playlist[index].id);
        } else if (!player) {
          createPlayer(playlist[index].id);
        }
        
        updateVideoInfo(playlist[index].id);
        renderPlaylist();
        savePlaylistToLocalStorage();
      }
    }

    function addVideo() {
      const input = document.getElementById('videoUrl').value.trim();
      if (!input) return;

      const videoId = extractVideoId(input);
      if (videoId) {
        // Check if video already exists in playlist
        if (playlist.some(video => video.id === videoId)) {
          alert("This video is already in your playlist!");
          return;
        }

        // Add video with placeholder title
        const newVideo = {
          id: videoId,
          hasError: false,
          errorCode: null,
          title: `Video ${playlist.length + 1}`, // Placeholder title
          titleLoaded: false
        };
        
        playlist.push(newVideo);
        savePlaylistToLocalStorage();
        updatePlaylistCount();
        renderPlaylist();

        // Try to fetch the title for this video
        fetchVideoTitle(newVideo, playlist.length - 1);

        // If this is the first video, start playing
        if (playlist.length === 1) {
          initializePlayer(videoId);
        }

        document.getElementById('videoUrl').value = '';
      } else {
        alert("Please enter a valid YouTube URL or Video ID");
      }
    }

    function extractVideoId(url) {
      // Handle direct video ID
      if (url.length === 11 && /^[a-zA-Z0-9_-]+$/.test(url)) {
        return url;
      }
      
      // Handle various YouTube URL formats
      const patterns = [
        /^(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/,
        /^(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
        /^(?:https?:\/\/)?(?:www\.)?youtu\.be\/([a-zA-Z0-9_-]{11})/
      ];
      
      for (let pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
          return match[1];
        }
      }
      
      return null;
    }

    function renderPlaylist() {
      const list = document.getElementById('playlist');
      
      if (playlist.length === 0) {
        list.innerHTML = `
          <div class="empty-playlist">
            <i class="bi bi-music-note-list"></i>
            <h5>No videos yet</h5>
            <p>Add YouTube videos using the input above</p>
          </div>
        `;
        return;
      }

      list.innerHTML = '';
      
      playlist.forEach((video, index) => {
        const li = document.createElement('div');
        li.className = 'playlist-item';
        
        if (video.hasError) {
          li.classList.add('error');
          li.innerHTML = `
            <div class="playlist-item-content">
              <div class="playlist-item-icon text-danger">
                <i class="bi bi-exclamation-triangle-fill"></i>
              </div>
              <div class="playlist-item-info">
                <div class="playlist-item-title text-danger">Playback Error</div>
                <div class="playlist-item-subtitle">ID: ${video.id}</div>
              </div>
              <div class="playlist-item-actions">
                <button class="btn btn-danger btn-sm" onclick="removeVideo(${index})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          `;
        } else {
          if (index === currentIndex) {
            li.classList.add('playing');
          }
          
          // Determine title to display
          let displayTitle = video.title || `Video ${index + 1}`;
          let titleClass = video.titleLoaded ? "playlist-item-title" : "playlist-item-title video-title-loading";
          
          li.innerHTML = `
            <div class="playlist-item-content" onclick="playVideoAtIndex(${index})" style="cursor: pointer;">
              <div class="playlist-item-icon" style="color: ${index === currentIndex ? '#ff0000' : '#666'};">
                <i class="bi bi-play-circle-fill"></i>
              </div>
              <div class="playlist-item-info">
                <div class="${titleClass}" title="${displayTitle}">${displayTitle}</div>
                <div class="playlist-item-subtitle">ID: ${video.id}</div>
              </div>
              <div class="playlist-item-actions">
                <button class="btn btn-danger btn-sm" onclick="removeVideo(${index}); event.stopPropagation();">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          `;
        }
        
        list.appendChild(li);
      });
    }

    function removeVideo(index) {
      if (index < 0 || index >= playlist.length) return;
      
      playlist.splice(index, 1);
      savePlaylistToLocalStorage();
      updatePlaylistCount();
      
      // Adjust current index if needed
      if (currentIndex >= playlist.length) {
        currentIndex = Math.max(0, playlist.length - 1);
      } else if (currentIndex > index) {
         currentIndex--;
      }
      
      renderPlaylist();
      
      // Play next available video or handle empty playlist
      if (playlist.length > 0) {
        if (index === currentIndex || index === currentIndex + 1) {
            let nextPlayableIndex = currentIndex;
            while (nextPlayableIndex < playlist.length && playlist[nextPlayableIndex].hasError) {
              nextPlayableIndex++;
            }
            
            if (nextPlayableIndex < playlist.length) {
              playVideoAtIndex(nextPlayableIndex);
            } else {
                nextPlayableIndex = currentIndex - 1;
                while (nextPlayableIndex >= 0 && playlist[nextPlayableIndex].hasError) {
                    nextPlayableIndex--;
                }
                if (nextPlayableIndex >= 0) {
                    playVideoAtIndex(nextPlayableIndex);
                } else {
                    if (player) {
                      try {
                        player.stopVideo();
                      } catch(e) {}
                    }
                    document.getElementById('videoInfo').className = 'video-info d-none';
                }
            }
        }
      } else {
        if (player) {
          try {
            player.stopVideo();
          } catch(e) {}
        }
        document.getElementById('videoInfo').className = 'video-info d-none';
      }
    }

    function updateVideoInfo(videoId) {
      const currentVideo = playlist[currentIndex];
      const displayTitle = currentVideo ? (currentVideo.title || `Video ${currentIndex + 1}`) : 'Unknown';
      document.getElementById('currentVideoInfo').textContent = displayTitle;
      document.getElementById('playlistPosition').textContent = `${currentIndex + 1}/${playlist.length}`;
      document.getElementById('videoInfo').className = 'video-info';
    }

    function markVideoAsError(index, errorCode) {
      if (playlist[index]) {
        playlist[index].hasError = true;
        playlist[index].errorCode = errorCode;
        savePlaylistToLocalStorage();
        renderPlaylist();
      }
    }

    function savePlaylistToLocalStorage() {
      try {
        localStorage.setItem('ytPlaylist', JSON.stringify(playlist));
      } catch (e) {
        console.error('Failed to save playlist to localStorage:', e);
      }
    }

    function updatePlaylistCount() {
      document.getElementById('playlistCount').textContent = playlist.length;
    }

    function clearPlaylist() {
      if (playlist.length === 0) return;
      
      if (confirm('Are you sure you want to clear the entire playlist?')) {
        playlist = [];
        currentIndex = 0;
        savePlaylistToLocalStorage();
        updatePlaylistCount();
        renderPlaylist();
        
        if (player) {
          try {
            player.stopVideo();
          } catch(e) {}
        }
        document.getElementById('videoInfo').className = 'video-info d-none';
        document.getElementById('videoUrl').value = '';
      }
    }

    // Fetch title for a single video
    function fetchVideoTitle(video, index) {
      // Try to get title from oEmbed (no API key required)
      const oEmbedUrl = `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${video.id}&format=json`;
      
      fetch(oEmbedUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          if (data && data.title) {
            video.title = data.title;
            video.titleLoaded = true;
            savePlaylistToLocalStorage();
            renderPlaylist();
          }
        })
        .catch(error => {
          console.log(`Could not fetch title for video ${video.id}:`, error);
          // Keep the placeholder title
        });
    }

    // Fetch titles for all videos in playlist
    function fetchPlaylistTitles() {
      playlist.forEach((video, index) => {
        if (!video.titleLoaded && !video.hasError) {
          // Add a small delay between requests to avoid overwhelming the server
          setTimeout(() => {
            fetchVideoTitle(video, index);
          }, index * 500);
        }
      });
    }

    // Allow Enter key to add video
    document.getElementById('videoUrl').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        addVideo();
      }
    });

    console.log('Ad Free Player - Mobile Optimized PWA');
  </script>
</body>
</html>